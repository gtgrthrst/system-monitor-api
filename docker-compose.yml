version: '3.8'

services:
  sysinfo-api:
    image: sysinfo-api:local
    build:
      context: https://github.com/gtgrthrst/system-monitor-api.git#main
      dockerfile_inline: |
        # Build stage - Go 1.23 required for kardianos/service
        FROM golang:1.23-alpine AS builder

        # Install CGO dependencies (required by go-sqlite3)
        RUN apk add --no-cache gcc musl-dev

        ENV GOPROXY=https://goproxy.io,direct
        WORKDIR /app

        # Copy all files
        COPY . .

        # Tidy dependencies
        RUN go mod tidy

        # Build with CGO enabled (required for sqlite3)
        RUN CGO_ENABLED=1 go build -ldflags '-linkmode external -extldflags "-static"' -o /sysinfo-api main.go

        # Runtime stage
        FROM alpine:latest
        RUN apk add --no-cache ca-certificates tzdata
        WORKDIR /data
        COPY --from=builder /sysinfo-api /sysinfo-api
        EXPOSE 8088
        ENV TZ=Asia/Taipei
        CMD ["/sysinfo-api"]
    ports:
      - "8088:8088"
    volumes:
      - sysinfo-data:/data
    restart: always
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8088/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

volumes:
  sysinfo-data:
