version: '3.8'

services:
  sysinfo-api:
    image: sysinfo-api:local
    build:
      context: https://github.com/gtgrthrst/system-monitor-api.git#main
      dockerfile_inline: |
        FROM golang:1.21-alpine AS builder
        ENV GOPROXY=https://goproxy.io,direct
        ENV CGO_ENABLED=0
        WORKDIR /app
        # 直接複製所有檔案
        COPY . .
        # 強制執行整理與補齊依賴，忽略原本可能損壞的 go.sum
        RUN go mod tidy
        # 編譯
        RUN go build -o /sysinfo-api main.go

        FROM alpine:latest
        # 為了讓監控工具能讀取系統資訊，安裝基本工具
        RUN apk add --no-cache ca-certificates
        WORKDIR /
        COPY --from=builder /sysinfo-api /sysinfo-api
        EXPOSE 8088
        CMD ["/sysinfo-api"]
    ports:
      - "8088:8088"
    volumes:
      - sysinfo-data:/data
    restart: always

volumes:
  sysinfo-data:
